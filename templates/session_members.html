{% extends "base.html" %}

{% block title %}Управление участниками{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-people-fill"></i> Управление участниками</h2>
                    <p class="text-muted mb-0">Сессия: <strong>{{ session.name }}</strong></p>
                    <small class="text-muted">Код доступа: <strong>{{ session.access_code }}</strong></small>
                </div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Вернуться к Dashboard
                </a>
            </div>

            <!-- Members List -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Участники сессии ({{ members|length }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Пользователь</th>
                                    <th>Email</th>
                                    <th>Роль</th>
                                    <th>Присоединился</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in members %}
                                <tr id="member-{{ member.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ member.user_profile_pic }}"
                                                 class="rounded-circle me-2"
                                                 width="32" height="32"
                                                 alt="{{ member.user_name }}">
                                            <strong>{{ member.user_name }}</strong>
                                            {% if member.is_owner %}
                                            <span class="badge bg-danger ms-2">Владелец</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>{{ member.user_email }}</td>
                                    <td>
                                        {% if is_owner or is_admin %}
                                        <select class="form-select form-select-sm role-select"
                                                data-member-id="{{ member.id }}"
                                                data-user-id="{{ member.user_id }}"
                                                {% if member.is_owner %}disabled{% endif %}>
                                            <option value="member" {% if member.role == 'member' %}selected{% endif %}>Участник</option>
                                            <option value="admin" {% if member.role == 'admin' %}selected{% endif %}>Администратор</option>
                                            <option value="wb_manager" {% if member.role == 'wb_manager' %}selected{% endif %}>Менеджер кабинета WB</option>
                                            <option value="warehouse_manager" {% if member.role == 'warehouse_manager' %}selected{% endif %}>Менеджер склада</option>
                                            <option value="production_manager" {% if member.role == 'production_manager' %}selected{% endif %}>Менеджер производства</option>
                                            <option value="printer" {% if member.role == 'printer' %}selected{% endif %}>Принтер</option>
                                            {% if member.is_owner %}
                                            <option value="owner" selected>Владелец</option>
                                            {% endif %}
                                        </select>
                                        {% else %}
                                        <span class="badge bg-{% if member.role == 'owner' %}danger{% elif member.role == 'admin' %}warning{% elif member.role == 'wb_manager' %}info{% elif member.role == 'warehouse_manager' %}success{% elif member.role == 'production_manager' %}primary{% elif member.role == 'printer' %}dark{% else %}secondary{% endif %}">
                                            {% if member.role == 'owner' %}Владелец
                                            {% elif member.role == 'admin' %}Администратор
                                            {% elif member.role == 'wb_manager' %}Менеджер кабинета WB
                                            {% elif member.role == 'warehouse_manager' %}Менеджер склада
                                            {% elif member.role == 'production_manager' %}Менеджер производства
                                            {% elif member.role == 'printer' %}Принтер
                                            {% else %}Участник{% endif %}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ member.joined_at[:10] }}</td>
                                    <td>
                                        {% if (is_owner or is_admin) and not member.is_owner %}
                                        <button class="btn btn-sm btn-danger remove-member"
                                                data-member-id="{{ member.id }}"
                                                data-user-id="{{ member.user_id }}"
                                                data-user-name="{{ member.user_name }}">
                                            <i class="bi bi-trash"></i> Удалить
                                        </button>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6><i class="bi bi-info-circle"></i> Информация о ролях:</h6>
                    <ul class="mb-0">
                        <li><strong>Владелец:</strong> полный контроль над сессией, может удалить сессию</li>
                        <li><strong>Администратор:</strong> может управлять участниками и изменять роли</li>
                        <li><strong>Участник:</strong> может работать с данными сессии</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Change member role
document.querySelectorAll('.role-select').forEach(select => {
    select.addEventListener('change', async (e) => {
        const memberId = e.target.dataset.memberId;
        const userId = e.target.dataset.userId;
        const newRole = e.target.value;
        const oldRole = e.target.dataset.oldRole || e.target.value;

        if (!confirm(`Изменить роль участника на "${newRole}"?`)) {
            e.target.value = oldRole;
            return;
        }

        try {
            const response = await fetch(`/sessions/{{ session.id }}/members/${userId}/update-role`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ role: newRole })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Роль успешно изменена');
                e.target.dataset.oldRole = newRole;
                location.reload();
            } else {
                alert(`Ошибка: ${data.error}`);
                e.target.value = oldRole;
            }
        } catch (error) {
            alert('Ошибка при изменении роли');
            console.error(error);
            e.target.value = oldRole;
        }
    });
});

// Remove member
document.querySelectorAll('.remove-member').forEach(button => {
    button.addEventListener('click', async (e) => {
        const memberId = e.target.closest('button').dataset.memberId;
        const userId = e.target.closest('button').dataset.userId;
        const userName = e.target.closest('button').dataset.userName;

        if (!confirm(`Вы уверены, что хотите удалить участника "${userName}" из сессии?`)) {
            return;
        }

        try {
            const response = await fetch(`/sessions/{{ session.id }}/members/${userId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                // Remove row from table
                document.getElementById(`member-${memberId}`).remove();
            } else {
                alert(`Ошибка: ${data.error}`);
            }
        } catch (error) {
            alert('Ошибка при удалении участника');
            console.error(error);
        }
    });
});
</script>
{% endblock %}
